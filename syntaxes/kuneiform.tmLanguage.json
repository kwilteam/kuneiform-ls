{
  "scopeName": "source.kuneiform",
  "fileTypes": ["kf"],
  "patterns": [
	{"include": "#type_declarations" },
	{"include": "#pkRefs"},
	{"include": "#comments"},
	{"include": "#colTypes"},
	{"include": "#attributes"},
	{"include": "#strings" },
	{"include": "#modifiers"},
	{"include": "#sqlKeywords"},
	{"include": "#contextual"}
  ],
  "repository": {
	"type_declarations": {
		"patterns": [
			{"include": "#database"},
			{"include": "#table"},
			{"include": "#actions"},
			{"include": "#procedures"},
			{"include": "#extensions"},
			{"include": "#fprocedures"},
			{"include": "#columns"}
		]
	},
	"database": {
		"patterns": [
			{
				"match": "\\b(database)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*;",
				"captures": {
					"1": { "name": "keyword.kf.types" },
					"2": { "name": "entity.db.name" }
				}
			}
		]
	},
	"table": {
        "patterns": [
            {
                "begin": "\\b(table)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*\\{",
                "end": "\\}",
                "beginCaptures": {
                    "1": { "name": "keyword.kf.types" },
                    "2": { "name": "entity.kf.name" }
                },
                "patterns": [
                    { "include": "#comments"},
                    {
                        "match": "(#[a-zA-Z_][a-zA-Z0-9_]*)\\s+(unique|index|primary)\\s*.*?(//.*)?",
                        "captures": {
                            "1": { "name": "entity.name.index" },
                            "2": { "name": "entity.kf.name" },
							"3": { "name": "comment.line.double-slash.kuneiform" }
                        }
                    },
					{
						"match": "(foreign)\\s+(key)\\s+\\(([a-zA-Z_][a-zA-Z0-9_]*)\\)\\s+(references)\\s+([a-zA-Z_][a-zA-Z0-9_]*)(\\s*\\(([a-zA-Z_][a-zA-Z0-9_]*)\\)\\s*(on\\s+update|on\\s+delete)?(\\s+[^;/,]*)?\\s*)?,?(\\s*//.*)?",
						"captures": {
							"1": { "name": "keyword.kf.foreign" },
							"2": { "name": "storage.kf.types" },
							"3": { "name": "entity.name.column" },
							"4": { "name": "keyword.kf.refs" },
							"5": { "name": "entity.name.table" },
							"7": { "name": "entity.name.column.refs" },
							"8": { "name": "storage.kf.attributes" },
							"9": { "name": "entity.name.fk.actions" },
							"10": { "name": "comment.line.double-slash.kuneiform" }
						}
					},
					{
                        "match": "\\b([a-zA-Z_][a-zA-Z0-9_]*)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*(primary key|primary|pk|primary_key)?(\\s*\\b[^;/,]*)?\\s*?(\\s*,\\s*)?(//.*)?$",
                        "captures": {
                            "1": { "name": "entity.name.column" },
                            "2": { "name": "storage.kf.types" },
                            "3": { "name": "keyword.kf.pk" },
                            "4": { 
								"patterns": [
									{"include": "#attributes"},
									{"include": "#boolean"},
									{"include": "#numbers"}
								]
							},
							"5": { "name": "delimiter.comma" },
							"6": { "name": "comment.line.double-slash.kuneiform" }
                        }
                    }
                ]
            }
        ]
    },
	"actions": {
		"patterns": [
			{
				"match": "\\b(action)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*\\(([^)]*)\\)\\s*([^{/]*)\\s*\\{\\s*(//.*)?",
				"captures": {
					"1": { "name": "keyword.kf.types" },
					"2": { "name": "entity.kf.name" },
					"3": { "name": "variable.parameter.kuneiform" },
					"4": { "name": "entity.kf.modifiers"},
					"5": { "name": "comment.line.double-slash.kuneiform" }
				}
			},
			{"include": "#comments"},
			{"include": "#return"},
			{"include": "#contextual"},
			{"include": "#numbers"},
			{"include": "#boolean"}
		]
	},
	"procedures": {
		"patterns": [
			{
				"match": "\\b(procedure)\\s+([\\w_]+)\\s*\\(([^)]*)\\)([^)(]*)?\\(?([^)]*)?\\)?\\s*{?\\s*(//.*)?",
				"captures": {
					"1": { "name": "keyword.kf.types" },
					"2": { "name": "entity.kf.name" },
					"3": { 
						"patterns": [
							{"include": "#fnArgs"}
						]
					},
					"4": { 
						"patterns": [
							{"include": "#modifiers"},
							{"include": "#tablemod"}
						]
					},
					"5": { 
						"patterns": [
							{
								"include": "#returnArgs"
							}
						] 
					},
					"6": { "name": "comment.line.double-slash.kuneiform" }
				}
			},
			{"include": "#comments"},
			{"include": "#return"},
			{"include": "#contextual"},
			{"include": "#sqlKeywords"},
			{"include": "#numbers"},
			{"include": "#boolean"}
		]
	},
	"fprocedures":{
		"patterns": [
			{
				"match": "\\b(foreign)\\s+(procedure)\\s+([\\w_]+)\\s*\\(([^)]*)\\)?\\s*(returns)?\\s*(table)?\\s*\\(?([^)]*)?\\)?\\s*(//.*)?",
				"captures": {
					"1": { "name": "keyword.kf.types" },
					"2": { "name": "entity.kf.name" },
					"3": { "name": "entity.name.column" },
					"4": {
						"patterns": [
							{"include": "#fnArgs"}
						]
					},
					"5": { "name": "entity.kf.modifiers" },
					"6": { "name": "storage.kf.attributes" },
					"7": {
						"patterns": [
							{"include": "#returnArgs"}
						]
					},
					"8": { "name": "comment.line.double-slash.kuneiform" }
				}
			}
		]
	},
	"fnArgs": {
		"patterns": [
			{
				"match": "\\b([a-zA-Z_][a-zA-Z0-9_$]*)?\\s*\\b([a-zA-Z_][a-zA-Z0-9_]*)",
				"captures": {
					"1": { "name": "entity.name.attribute" },
					"2": { "name": "storage.kf.types" }
				}
			}
		]
	},
	"returnArgs": {
		"patterns": [
			{
				"match": "\\b([a-zA-Z_][a-zA-Z0-9_]*)?\\s*\\b([a-zA-Z_][a-zA-Z0-9_]*)",
				"captures": {
					"1": { "name": "entity.name.attribute" },
					"2": { "name": "storage.kf.types" }
				}
			}
		]
	},
	"extensions": {
		"patterns": [
			{
				"begin": "\\b(use)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*{",
				"end": "}\\s*(as)\\s*([a-zA-Z_][a-zA-Z0-9_]*);",
				"beginCaptures": {
					"1": { "name": "keyword.kf.types"},
					"2": { "name": "entity.kf.name" }
				},
				"endCaptures": {
					"1": { "name": "storage.kf.attributes" },
					"2": { "name": "entity.name.table" }
				},
				"patterns": [
					{"include": "#comments"},
					{"include": "#strings"}
				]
			}
		]
	},
	"colTypes": {
		"patterns": [
			{
				"match": "\\b(text|int|blob|bool|uuid|uint256|decimal)\\b",
				"name": "storage.kf.types"
			}
		]
	},
	"attributes": {
		"patterns": [
			{
				"match": "\\b(maxlen|minlen|unique|max|min|notnull|default|not null)\\b",
				"name": "storage.kf.attributes"
			}
		]
	},
	"comments": {
		"patterns": [
			{
				"match": "//\\s*TODO:.*$",
				"name": "comment.TODO.kuneiform"
			},
			{
				"match": "//.*$",
				"name": "comment.line.double-slash.kuneiform"
			}
		]
	},
	"pkRefs": {
		"patterns": [
			{
				"match": "primary|primary key|pk|primary_key",
				"name": "keyword.kf.pk"
			}
		]
	}, 
	"strings": {
        "patterns": [
			{
				"match": "'([^'])*'",
				"name": "string.quoted.single.kuneiform"
			}
        ]
    },
	"modifiers": {
		"patterns": [
			{
				"match": "\\b(public|private|view|owner|returns)\\b",
				"name": "entity.kf.modifiers"
			}
		]
	},
	"sqlKeywords": {
		"patterns": [
			{
				"name": "keyword.control.sql",
				"match": "(?<!\\$)\\b(?:ABORT|ADD|ALL|AND|AS|ASC|BETWEEN|BY|CASE|COLLATE|COMMIT|CONFLICT|CREATE|CROSS|DEFAULT|DELETE|DESC|DISTINCT|ELSE|END|ESCAPE|EXCEPT|EXISTS|FAIL|FROM|FULL|GLOB|GROUP|HAVING|IGNORE|IN|INDEXED|INNER|INSERT|INTERSECT|INTO|IS|ISNULL|JOIN|LEFT|LIKE|LIMIT|MATCH|NATURAL|NOT|NULL|OF|OFFSET|ON|OR|ORDER|OUTER|RAISE|REGEXP|REPLACE|RETURNING|RIGHT|ROLLBACK|SELECT|SET|THEN|UNION|UPDATE|USING|VALUES|WHEN|WHERE|WITH|TRUE|FALSE|NULLS|FIRST|LAST|FILTER|GROUPS|DO|NOTHING|abort|add|all|and|as|asc|between|by|case|collate|commit|conflict|create|cross|default|delete|desc|distinct|end|escape|except|exists|fail|from|full|glob|group|having|ignore|in|indexed|inner|insert|intersect|into|is|isnull|join|left|like|limit|match|natural|not|null|of|offset|on|or|order|outer|raise|regexp|replace|returning|right|rollback|select|set|then|union|update|using|values|when|where|with|true|false|nulls|first|last|filter|groups|do|nothing|delete|update)\\b"
			  }
		]
	},
	"operators": {
		"patterns": [
        {
          "name": "keyword.operator.kuneiform",
          "match": "[=><!~?:&|+\\-*^%]+"
        }
      ]
	},
	"return": {
		"patterns": [
			{
				"match": "\\b(return)\\b",
				"name": "keyword.kf.return"
			}
		]
	},
	"tablemod": {
		"patterns": [
			{
				"match": "\\b(table)\\b",
				"name": "storage.kf.attributes"
			}
		]
	},
	"functionCall": {
		"patterns": [
			{
				"match": "\\b([a-zA-Z_][a-zA-Z0-9_]*).([a-zA-Z_][a-zA-Z0-9_]*)\\s*\\(",
				"captures": {
					"2": { "name": "entity.name.function" }
				}
			}
		]
	},
	"contextual": {
		"patterns": [
			{
				"match": "(@caller|@signer|@height|@txid)",
				"captures": {
					"1": { "name": "keyword.other.contextual.kuneiform" }
				}
			}
		]
	},
	"numbers": {
		"patterns": [
			{
				"match": "\\b(\\d+)\\b",
				"name": "constant.numeric.kuneiform"
			}
		]
	},
	"boolean": {
		"patterns": [
			{
				"match": "\\b(true|false)\\b",
				"name": "constant.boolean.kuneiform"
			}
		]
	}
  }
}	
